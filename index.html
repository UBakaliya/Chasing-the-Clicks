<!-- @format -->

<!DOCTYPE html>
<html>
    <head>
        <title>Chasing the Clicks</title>
        <style>
            /* Center the button */
            button {
                display: block;
                margin: 0 auto;
                font-size: 2rem;
                padding: 1rem 2rem;
                background-color: #0096c7;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }

            /* Center the click count */
            #count {
                text-align: center;
                font-size: 3rem;
                margin-top: 2rem;
            }

            /* Center the country table */
            #country-table {
                margin: 2rem auto;
                font-size: 1.5rem;
            }

            #country-table th,
            #country-table td {
                padding: 0.5rem 1rem;
                text-align: center;
                border: 1px solid black;
            }

            #country-table th {
                background-color: #0096c7;
                color: white;
            }
        </style>
    </head>
    <body>
        <button id="click-button">Click me!</button>
        <div id="count">0</div>
        <table id="country-table">
            <thead>
                <tr>
                    <th>Country</th>
                    <th>Clicks</th>
                </tr>
            </thead>
            <tbody id="country-data"></tbody>
        </table>
        <script>
            // Get the button and count elements
            const button = document.getElementById("click-button")
            const count = document.getElementById("count")

            // Initialize the count to the previous value or 0
            let clickCount = localStorage.getItem("clickCount") || 0
            count.textContent = clickCount

            // Initialize the country data to the previous value or empty object
            let countryData =
                JSON.parse(localStorage.getItem("countryData")) || {}

            // Add a click event listener to the button
            button.addEventListener("click", () => {
                // Increment the count
                clickCount++
                count.textContent = clickCount

                // Store the count in localStorage
                localStorage.setItem("clickCount", clickCount)

                // Ask for permission before getting the user's location
                if (navigator.permissions) {
                    navigator.permissions
                        .query({ name: "geolocation" })
                        .then(result => {
                            if (result.state === "granted") {
                                // Get the user's country using the IP API
                                navigator.geolocation.getCurrentPosition(
                                    position => {
                                        const url = `https://ipapi.co/json/${position.coords.latitude},${position.coords.longitude}/`
                                        fetch(url)
                                            .then(response => response.json())
                                            .then(data => {
                                                const country =
                                                    data.country_name
                                                countryData[country] =
                                                    (countryData[country] ||
                                                        0) + 1
                                                localStorage.setItem(
                                                    "countryData",
                                                    JSON.stringify(countryData)
                                                )
                                                updateCountryTable(countryData)
                                            })
                                            .catch(error =>
                                                console.error(error)
                                            )
                                    }
                                )
                            } else if (result.state === "prompt") {
                                navigator.geolocation.getCurrentPosition(
                                    position => {
                                        const url = `https://ipapi.co/json/${position.coords.latitude},${position.coords.longitude}/`
                                        fetch(url)
                                            .then(response => response.json())
                                            .then(data => {
                                                const country =
                                                    data.country_name
                                                countryData[country] =
                                                    (countryData[country] ||
                                                        0) + 1
                                                localStorage.setItem(
                                                    "countryData",
                                                    JSON.stringify(countryData)
                                                )
                                                updateCountryTable(countryData)
                                            })
                                            .catch(error =>
                                                console.error(error)
                                            )
                                    }
                                )
                            } else if (result.state === "denied") {
                                console.error("Geolocation permission denied.")
                            }
                        })
                } else {
                    console.error(
                        "Geolocation is not supported by this browser."
                    )
                }
            })

            // Display the click count and country data on page load
            count.textContent = clickCount
            updateCountryTable(countryData)

            function updateCountryTable(countryData) {
                const tableBody = document.getElementById("country-data")
                tableBody.innerHTML = ""
                for (const country in countryData) {
                    const count = countryData[country]
                    const row = document.createElement("tr")
                    const countryCell = document.createElement("td")
                    const countCell = document.createElement("td")
                    countryCell.textContent = country
                    countCell.textContent = count
                    row.appendChild(countryCell)
                    row.appendChild(countCell)
                    tableBody.appendChild(row)
                }
            }
        </script>
    </body>
</html>
